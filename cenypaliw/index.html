<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Ceny Hurtowe Paliw</title>
    <style>
        @font-face {
            font-family: 'Myriad Pro Condensed';
            src: url('https://fonts.cdnfonts.com/s/9045/MyriadPro-Cond.otf') format('opentype');
        }

        body {
            font-family: 'Outfit', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            overflow: hidden;
        }

        .container {
            text-align: center;
            width: 80%;
            display: none;
        }

        .loading {
            font-size: 24px;
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 26px;
            text-align: left;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }

        th, td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        th:last-child {
            border-right: none;
        }

        .icon {
            width: 50px;
            height: 50px;
        }

        .bold {
            font-weight: bold;
        }

        .update-info {
           position: absolute;
           bottom: 20px;
           left: 20px; 
           font-size: 14px;
           color: #555;
        }

        .countdown {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: #555;
            margin-top: 20px;
        }

        .light-theme {
            color: #000;
            background-color: #f4f4f9;
        }

        .dark-theme {
            color: #fff;
            background-color: #1d1f21;
        }

        .dark-theme .update-info, .dark-theme .info, .dark-theme .countdown {
            color: #fff;
        }

        .dark-theme th {
            background-color: #323232;
        }

        .dark-theme table {
            background-color: #2d2d2d;
        }

        .dark-theme .modal-content {
            background-color: #323232;
        }

        .theme-toggle, .history-toggle {
            position: absolute;
            top: 10px;
            cursor: pointer;
            color: #555;
            font-size: 24px;
        }

        .theme-toggle {
            right: 10px;
        }

        .history-toggle {
            right: 50px;
        }

        .info {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            font-size: 20px;
            color: #555;
        }

        .info i {
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 25px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body>
    <div class="loading" id="loading">Ładowanie danych...</div>
    <div class="container" id="container">
      <div class="info">
        <i class='bx bxs-info-circle'></i>
        <span class="info-text">Odliczanie nie jest synchronizowane równo z czasem</span>
      </div>
    
        <h1>Ceny Hurtowe Paliw</h1>
        <table>
            <thead>
                <tr>
                    <th>Paliwo</th>
                    <th>Cena z podatkiem (PLN)</th>
                </tr>
            </thead>
            <tbody id="fuelTableBody">
                <!-- Dane zostaną tutaj wstawione przez JavaScript -->
            </tbody>
        </table>
        <div class="update-info" id="updateInfo"></div>
        <div class="countdown" id="countdown"></div>
        <div class="notification" id="notification"></div>

        <div class="theme-toggle" onclick="toggleTheme()">
            <i class='bx bxs-adjust'></i>
        </div>
        <div class="history-toggle" onclick="showHistory()">
            <i class='bx bxs-time'></i>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistory()">&times;</span>
            <h2>Historia Cen Paliw</h2>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Paliwo</th>
                        <th>Cena z podatkiem (PLN)</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Historia cen paliw -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = 'https://tool.orlen.pl/api/wholesalefuelprices';
        const historyKey = 'fuelPriceHistory';

        const productIcons = {
            'Pb95': 'img/efecta95.png',
            'Pb98': 'img/verva98.png',
            'ONEkodiesel': 'img/efectadiesel.png',
            'ONArctic2': 'img/vervadiesel.png'
        };

        function saveHistory(data) {
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];
            history.push(data);
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        function fetchHistory() {
            return JSON.parse(localStorage.getItem(historyKey)) || [];
        }

        function displayHistory() {
            const history = fetchHistory();
            const historyTableBody = document.getElementById('historyTableBody');
            historyTableBody.innerHTML = '';
            history.forEach(record => {
                record.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td><img class="icon" src="${productIcons[item.productName]}" alt="${item.productName}"></td>
                        <td>${item.value}</td>
                    `;
                    historyTableBody.appendChild(row);
                });
            });
        }

        function fetchData() {
            showNotification("Odświeżono dane.");
            document.getElementById('loading').style.display = 'block';
            document.getElementById('container').style.display = 'none';

            fetch(proxyUrl + encodeURIComponent(targetUrl))
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched data:', data);

                    let pb95ValueWithTax;
                    let onEkodieselValueWithTax;

                    const jsonData = JSON.parse(data.contents);
                    console.log('Parsed JSON data:', jsonData);

                    const publishFrom = jsonData[0]?.publishFrom?.replace('T', ' ') || 'brak danych';
                    document.getElementById('updateInfo').textContent = `Ostatnia aktualizacja: ${publishFrom}`;

                    const initialData = jsonData.filter(item => item.productName !== 'Pb98' && item.productName !== 'ONArctic2' && item.productName !== 'OnEkoterm');
                    console.log('Filtered initial data:', initialData);

                    const filteredData = initialData.map(item => {
                        let taxRate = 0;
                        if (item.productName === 'Pb95' || item.productName === 'ONEkodiesel') {
                            taxRate = 0.26;
                        } else if (item.productName === 'ONArctic2') {
                            taxRate = 0.23;
                        }

                        let valueWithTax = (item.value / 1000) * (1 + taxRate);
                        if (item.productName === 'Pb95') {
                            pb95ValueWithTax = valueWithTax;
                        } else if (item.productName === 'ONEkodiesel') {
                            onEkodieselValueWithTax = valueWithTax;
                        }

                        return {
                            productName: item.productName,
                            value: valueWithTax.toFixed(2)
                        };
                    });

                    console.log('Filtered data with tax:', filteredData);

                    if (pb95ValueWithTax !== undefined) {
                        const pb98ValueWithTax = pb95ValueWithTax + 0.60;
                        filteredData.push({
                            productName: 'Pb98',
                            value: pb98ValueWithTax.toFixed(2)
                        });
                    }

                    if (onEkodieselValueWithTax !== undefined) {
                        const onArctic2ValueWithTax = onEkodieselValueWithTax + 0.20;
                        filteredData.push({
                            productName: 'ONArctic2',
                            value: onArctic2ValueWithTax.toFixed(2)
                        });
                    }

                    console.log('Final data:', filteredData);

                    const tableBody = document.getElementById('fuelTableBody');
                    tableBody.innerHTML = '';
                    filteredData.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img class="icon" src="${productIcons[item.productName]}" alt="${item.productName}"></td>
                            <td class="bold" style="font-family: 'Outfit', sans-serif;">${item.value}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('container').style.display = 'block';

                    const currentDate = new Date().toLocaleDateString();
                    saveHistory({ date: currentDate, data: filteredData });
                })
                .catch(error => console.error('Error:', error));
        }

        function startCountdown() {
            let countdownTime = 1 * 60;
            const countdownElement = document.getElementById('countdown');

            function updateCountdown() {
                const minutes = Math.floor(countdownTime / 60);
                const seconds = countdownTime % 60;
                countdownElement.textContent = `Odświeżenie za: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                countdownTime--;

                if (countdownTime < 0) {
                    countdownTime = 1 * 60;
                }
            }

            setInterval(updateCountdown, 1000);
        }

        const notificationElement = document.getElementById('notification');

        function showNotification(message) {
           notificationElement.textContent = message;
           notificationElement.style.display = 'block';
           setTimeout(() => {
           notificationElement.style.display = 'none';
         }, 3000);
        }

        let isDarkTheme = false;

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-theme');
            body.classList.toggle('dark-theme');
            isDarkTheme = !isDarkTheme;
        }

        function showHistory() {
            displayHistory();
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        fetchData();
        setInterval(fetchData, 1 * 60 * 1000);
        startCountdown();
    </script>
</body>
</html>
